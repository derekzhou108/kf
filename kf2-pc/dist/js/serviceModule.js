"use strict";var serviceModuleVm=avalon.define({$id:"service",time:60,successCode:1e4,app:util.getStorage("app")||!1,userInfo:util.getStorage("userInfo")||!1,pId:util.getStorage("app")&&util.getStorage("app").pId||"",activeModule:-1,activeDay:1,verifiCode:"",crumbPath:"/pc/service",crumbName:"自助服务",count:0,limit:8,curr:1,currentModule:"",unbindPhoneInfo:{step:1,phoneNum:"",verifyCode:""},bindEmailInfo:{emailError:!1,emailCodeError:!1,emailCode:"",emailAddress:"",showEmailAddress:"",step:1,bindEmailPro:"icon-1",btnText:"下一步",errorText:"邮箱地址不能为空！"},unbindEmailInfo:{emailError:!1,emailCodeError:!1,emailCode:"",emailAddress:"",step:1,unbindEmailPro:"icon-1",btnText:"继续"},findPwInfo:{bindInfo:"",account:"",selected:3,step:1,verificationCode:"",labelName:"当前绑定的手机",newPWD:"",newPWDAffirm:"",verifiCode:"",accountError:!1,codeError:!1},bindPhoneInfo:{step:1,phoneNum:"",verificationCode:""},changePwInfo:{step:1,oldPWD:"",newPWD:"",newPWDAffirm:""},findAccountBackInfo:{phoneNum:"",code:"",step:1,accountNum:""},accountChannel:{step:1,accountChannelName:"",codeError:!1,roleNameError:!1,roleName:"",roleID:""},verificationCode:util.randomVerificationCode(6),gameList:[],serverList:[],serverListData:[],gameKey:"",serverKey:"",tableData:{headList:["游戏","服务器","角色名","角色ID","等级"],tableList:[]},rechargeTable:{headList:["游戏","服务器","角色名","充值金额","充值时间","状态"],tableList:[]},selectServer:function(e,n){this.serverKey=e.value},selectGame:function(e,n){var o=this;o.gameKey=e.value,o.serverListData.forEach(function(e,n){e.appid===o.gameKey&&(o.serverList=e.serverList.map(function(e,n){return{val:e.id,text:e.serverName}}))})},searchRoleList:function(){var e=this,n=e.gameKey||"";e.userInfo?""!==n?e.fetchRoleList({appId:n,sdkUserId:e.userInfo.user_id}):dialog.errorMsg("请先选择要查询的游戏！"):account.login()},nextStep:function(){var e=this;if(""!==e.bindEmailInfo.emailAddress&&1===e.bindEmailInfo.step)return void(/^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/.test(e.bindEmailInfo.emailAddress)?api.isExitsEmail({email:e.bindEmailInfo.emailAddress}).then(function(n){if(1e4===n.code){var o=e.bindEmailInfo.emailAddress;e.bindEmailInfo.showEmailAddress=o.replace(o.substring(4,o.lastIndexOf("@")-2),"****"),e.bindEmailInfo.step++}else e.bindEmailInfo.errorText=n.msg,e.bindEmailInfo.emailError=!0}):(e.bindEmailInfo.errorText="邮箱格式不正确！",e.bindEmailInfo.emailError=!0));if(e.bindEmailInfo.emailError=!0,""!==e.bindEmailInfo.emailAddress&&""!==e.bindEmailInfo.emailCode&&2===e.bindEmailInfo.step){var n={sdkUserId:e.userInfo.user_id,email:e.bindEmailInfo.emailAddress,code:e.bindEmailInfo.emailCode};api.bindEmail(n).then(function(n){e.successCode===n.code?e.bindEmailInfo.step++:dialog.errorMsg(n.msg)})}else e.bindEmailInfo.emailCodeError=!0},nextStepUPH:function(){var e=this;if(1===e.unbindPhoneInfo.step)return void api.getBindInfo().then(function(n){e.successCode===n.code&&(""!==n.data.phoneNum?(e.unbindPhoneInfo.phoneNum=n.data.phoneNum,e.unbindPhoneInfo.step++):dialog.message("温馨提示","该帐号还未绑定过手机！"))});""!==e.unbindPhoneInfo.verifyCode&&2===e.unbindPhoneInfo.step&&e.unbindPhoneInfo.step++},nextStepUBE:function(){var e=this;if(1===e.unbindEmailInfo.step)return void e.unbindEmailInfo.step++;""!==e.unbindEmailInfo.emailCode&&2===e.unbindEmailInfo.step?e.unbindEmailInfo.step++:e.unbindEmailInfo.emailCodeError=!0},nextStepFPW:function(){var e=this;if(1===e.findPwInfo.step){if(3===e.findPwInfo.selected?e.findPwInfo.labelName="当前绑定的手机":e.findPwInfo.labelName="当前绑定的邮箱",""===e.findPwInfo.account)return void(e.findPwInfo.accountError=!0);if(e.findPwInfo.verifiCode.toLocaleLowerCase()!==e.verificationCode.toLocaleLowerCase())return void(e.findPwInfo.codeError=!0);api.getBindInfoByAccount({user_name:e.findPwInfo.account,type:e.findPwInfo.selected}).then(function(n){1e4===n.code?(e.findPwInfo.bindInfo=n.data.content,e.findPwInfo.step++):dialog.errorMsg(n.msg)})}else if(2===e.findPwInfo.step)""!==e.findPwInfo.verificationCode?api.checkFindPWDCode({user_name:e.findPwInfo.account,type:e.findPwInfo.selected,code:e.findPwInfo.verificationCode}).then(function(n){1e4===n.code?e.findPwInfo.step++:dialog.errorMsg(n.msg)}):dialog.errorMsg("验证码不能为空！");else if(3===e.findPwInfo.step){if(""===e.findPwInfo.newPWD||""===e.findPwInfo.newPWDAffirm)return void dialog.errorMsg("密码不能为空！");if(e.findPwInfo.newPWD!==e.findPwInfo.newPWDAffirm)return void dialog.errorMsg("密码不一致");if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,18}$/.test(e.findPwInfo.newPWD))return void dialog.errorMsg("密码格式不正确！");api.setNewPw({user_name:e.findPwInfo.account,password:e.findPwInfo.newPWD}).then(function(n){1e4===n.code?e.findPwInfo.step++:dialog.errorMsg(n.msg)})}},nextStepCPW:function(){var e=this;if(1===e.changePwInfo.step){if(""===e.changePwInfo.oldPWD||""===e.changePwInfo.newPWD||""===e.changePwInfo.newPWDAffirm)return void dialog.errorMsg("密码不能为空！");if(e.changePwInfo.newPWD!==e.changePwInfo.newPWDAffirm)return void dialog.errorMsg("新密码不一致");if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,18}$/.test(e.changePwInfo.newPWD))return void dialog.errorMsg("密码格式不正确！");api.changePWD({sdkUserId:e.userInfo.user_id,old_password:e.changePwInfo.oldPWD,new_password:e.changePwInfo.newPWD}).then(function(n){1e4===n.code?e.changePwInfo.step++:dialog.errorMsg(n.msg)})}},sendFindAccountCode:function(e,n){var o=this,i=window.event||e,r=i.srcElement;return r||(r=i.target),n?/^1(3|4|5|7|8)\d{9}$/.test(n)?void api.getAccountCode({phone:n}).then(function(e){1e4===e.code?o.countDown(r):dialog.errorMsg(e.msg)}):void dialog.errorMsg("手机号码格式不正确"):void dialog.errorMsg("请输入手机号码")},findAccountBack:function(){var e=this;if(""===e.findAccountBackInfo.code)return void dialog.errorMsg("验证码不能为空！");api.getUserAccount({phone:e.findAccountBackInfo.phoneNum,code:e.findAccountBackInfo.code}).then(function(n){1e4===n.code?(e.findAccountBackInfo.accountNum=n.data.account,e.findAccountBackInfo.step++):dialog.errorMsg(n.msg)})},bindPhone:function(){var e=this;""!==e.bindPhoneInfo.phoneNum&&""!==e.bindPhoneInfo.verificationCode&&api.bindPhone({sdkUserId:e.userInfo.user_id,phone:e.bindPhoneInfo.phoneNum,code:e.bindPhoneInfo.verificationCode}).then(function(n){e.successCode===n.code?e.bindPhoneInfo.step=2:dialog.errorMsg(n.msg)})},changeVerifcateCode:function(){serviceModuleVm.verificationCode=util.randomVerificationCode(6)},jump:function(e){var n=this;n.fetchRechargDatail(n.activeDay,e.curr,10)},fetchRechargDatail:function(e,n,o){var i=this;if(i.activeDay=e,i.limit=o,i.curr=n,i.userInfo){var r={pId:i.app.pId||"",pageIdx:n,pageSize:o,sdkUserId:i.userInfo.user_id,activeDay:i.activeDay};api.queryRechargeDetail(r).then(function(e){i.successCode===e.code?(i.rechargeTable.tableList=e.data,i.count=e.total,i.limit=o):(i.rechargeTable.tableList=[],i.count=e.total||0,dialog.errorMsg(e.msg))})}},queryAccountChannel:function(){var e=this;if(e.verifiCode.toLocaleLowerCase()===e.verificationCode.toLocaleLowerCase()){var n={appId:e.gameKey,serverId:e.serverKey,roleId:e.accountChannel.roleID},o={appId:e.gameKey,serverId:e.serverKey,roleName:e.accountChannel.roleName},i=""===e.accountChannel.roleName?n:o;if(""===e.accountChannel.roleName&&""===e.accountChannel.roleID)return void dialog.errorMsg("角色名和角色ID需任意填写一项！");api.queryRoleChannel(i).then(function(n){1e4===n.code?(e.accountChannel.accountChannelName=n.data.channelName,e.accountChannel.step++):dialog.errorMsg(n.msg)})}else e.accountChannel.codeError=!0},cancel:function(){window.open("/pc/service","_self")},countDown:function(e){var n=this,o=n.time;e.innerHTML=n.time+"s",e.disabled=!0;var i=setInterval(function(){0==n.time?(clearInterval(i),e.innerHTML="免费获取验证码",e.disabled=!1,n.time=o):(n.time--,e.innerHTML=n.time+"s")},1e3)},sendCode:function(e,n,o){var i=this,r=window.event||e,t=r.srcElement;if(t||(t=r.target),1===o){if(!n)return void dialog.errorMsg("请输入手机号码");if(!/^1(3|4|5|7|8)\d{9}$/.test(n))return void dialog.errorMsg("手机号码格式不正确")}api.getSendCode({sdkUserId:this.userInfo.user_id,content:n,type:o}).then(function(e){1e4===e.code?i.countDown(t):dialog.errorMsg(e.msg)})},sendFindPWCode:function(e,n,o){var i=this,r=window.event||e,t=r.srcElement;t||(t=r.target),api.getFindPWCode({user_name:n,type:o}).then(function(e){1e4===e.code?i.countDown(t):dialog.errorMsg(e.msg)})},fetchRoleList:function(e){var n=this;api.roleList(e).then(function(e){n.successCode===e.code?n.tableData.tableList=e.data:(dialog.errorMsg(e.msg),n.tableData.tableList=[])})}});serviceModuleVm.$watch("onReady",function(){var e=this;setTimeout(function(){if(util.getQueryString("moduleName")&&(e.currentModule=util.getQueryString("moduleName")),util.getQueryString("type")){if(e.activeModule=util.getQueryString("type"),8===parseInt(e.activeModule))return void e.fetchRechargDatail(e.activeDay,1,10);9===parseInt(e.activeModule)&&api.gameSeverList({pId:e.pId}).then(function(n){1e4===n.code?(e.serverListData=n.data,e.gameList=n.data.map(function(e,n){return{val:e.appid,text:e.app_name}})):dialog.errorMsg(n.msg)}),10===parseInt(e.activeModule)&&(e.verificationCode=util.randomVerificationCode(6),api.gameSeverList({pId:e.pId}).then(function(n){e.serverListData=n.data,e.gameList=n.data.map(function(e,n){return{val:e.appid,text:e.app_name,server_list:e.serverList}})}))}},10)});